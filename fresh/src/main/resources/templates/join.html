<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
	<head>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<meta charset="UTF-8">
		<meta name="_csrf" th:content="${_csrf.token}">
        <meta name="_csrf_header" th:content="${_csrf.headerName}">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<meta name="description" content="">
		<meta name="author" content="">
		<!-- sweetalert2 -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"	integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<title>会員登録</title>
		<style>
		/*@import url("http://fonts.googleapis.com/earlyaccess/nanumgothic.css");*/
		
		html {
			height: 100%;
		}
		
		body {
			
			width: 100%;
			height: 100%;
			margin: 0;
			padding-top: 90px;
			padding-bottom: 40px;
			font-family: "Nanum Gothic", arial, helvetica, sans-serif;
			background-repeat: no-repeat;
		}
		
		.card {
			margin: 0 auto; /* Added */
			float: none; /* Added */
			margin-bottom: 10px; /* Added */
		}
		
		#join-btn {
			background-color: #e4932b;
			border: none;
		}
		
		.form-signin .form-control {
			position: relative;
			height: auto;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			padding: 10px;
			font-size: 16px;
		}
		#check_id{
			margin-bottom: 5px;
		}
		#check_pw{
			margin-bottom: 5px;
		}
		#check_pwc{
			margin-bottom: 5px;
		}
		#check_name{
			margin-bottom: 5px;
		}
		#check_username{
			margin-bottom: 5px;
		}
		#check_email{
			margin-bottom: 5px;
		}
		.card-title {
			margin-left: 30px;
		}
		
		.links {
			text-align: center;
			margin-bottom: 10px;
		}
		
		a {
			color: #f58b34;
			text-decoration: none;
		}
		
		</style>
	</head>

	<body cellpadding="0" cellspacing="0" marginleft="0" margintop="0" width="100%" height="100%" align="center">
		<div class="card align-middle" style="width: 600px;">
			<div class="card-title" style="margin-top: 30px;">
				<h2 class="card-title" style="color: #f58b34;">
					<img th:src ="@{/css/icon/logo.png}"/>
				</h2>
			</div>
			<div class="card-body">
				<form action="/join" name="join" id="join"method="POST">
					<input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
					<div class="input-group mb-3">
  						<input type="text" class="form-control" name="user_id" id="user_id" placeholder="ID">
  						<button class="btn btn-warning" type="button" onclick="checkId()">重複確認</button>
					</div>
					<div id="check_id">&nbsp;</div>
					
					<div class= "input-group mb-3">
						<input type="password" name="user_pw" id="user_pw" class="form-control"placeholder="パスワード" required>
					</div>
					<div id="check_pw">&nbsp;</div>
					
					<div class= "input-group mb-3">
						<input type="password" name="pw_chk" id="pw_chk" class="form-control"placeholder="パスワードの再確認" required>
					</div>
					<div id="check_pwc">&nbsp;</div>
					
					<div class= "input-group mb-3">
						<input type="text" name="user_name" id="user_name" class="form-control" placeholder="名前を入力して下さい。" required>
					</div>
					<div id="check_name">&nbsp;</div>
					
					<div class= "input-group mb-3">
						<input type="email" class="form-control" name="user_email" id="user_email" placeholder="メールアドレスを入力して下さい。">
  						<button class="btn btn-warning" type="button" onclick="sendEmail()">認証番号を送信</button>
					</div>
					<div id="check_email">&nbsp;</div>
					
					<div class= "input-group mb-3">
						<input type="text" class="form-control" name="email_auth" id="email_auth" placeholder="認証番号を入力して下さい。">
  						<button class="btn btn-warning" type="button" onclick="verifyEmail()">認証番号を確認</button>
					</div>
					<div>&nbsp;</div>
					
					<div class= "input-group mb-3">
						<input type="text" class="form-control" name="user_username" id="user_username" placeholder="닉네임을 입력해주세요">
  						<button class="btn btn-warning" type="button" onclick="checkUserName()">중복확인</button>
					</div>
					<div id="check_username">&nbsp;</div>		
					<br>			
					<button id="join-btn" class="btn btn-lg btn-primary btn-block" type="button">회 원 가 입</button>
				</form>
			</div>
		</div>
	</body>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script type="text/javascript">
	    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

	    // 정규식 정의
	    const checkID = RegExp(/^(?=.*\d)(?=.*[a-zA-Z])[0-9a-zA-Z]{4,}$/);
	    const checkPW = RegExp(/^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[~!@#$%^&*()_+])[A-Za-z\d~!@#$%^&*()_+]{8,}$/);
	    const checkName = RegExp(/^[가-힣]|[A-Z]|[a-z]$/);
	    const checkEmail = RegExp(/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i);
	    const checkUserNmae = RegExp(/^[0-9A-Za-z가-힣ㄱ-ㅎㅏ-ㅣぁ-んァ-ヶ\u4E00-\u9FFF]+$/);

	    // 모든 입력 필드의 유효성 상태를 추적
	    let isIdValid = false;					//아이디 상태
	    let isPwValid = false;					//비밀번호 상태
	    let isPwChkValid = false;				//비밀번호 확인 상태
	    let isNameValid = false;				//이름 상태
	    let isEmailValid = false;				//이메일 상태
	    let isUsernameValid = false;			//닉네임 상태
	    let isAuthValid = false; 				//인증번호 상태 추적

	  //회원가입 페이지 스페이스바 금지 시발
		$(document).keydown(function(event){
			if(event.keyCode === 32){
				event.preventDefault();
			}
		})
	    // 입력 필드 유효성 검사 시 상태 업데이트 및 버튼 활성화
	    function updateButtonState() {
	        if (isIdValid && isPwValid && isPwChkValid && isNameValid && isEmailValid && isUsernameValid) {
	            $("#join-btn").prop("disabled", false);
	        } else {
	            $("#join-btn").prop("disabled", true);
	        }
	    }

	    // 유효성 검사 이벤트 등록
	    $(function () {
	        // 아이디 유효성 검사
	        $("#user_id").blur(function () {
	            const userId = $(this).val();
	            if (!checkID.test(userId)) {
	            	$('#check_id').text('아이디는 영어대소문자 및 숫자를 조합해서 4자리 이상입니다.');
					$('#check_id').css('color', 'red');
	                isIdValid = false;
	                return false;
	            } else {
	            	$('#check_id').text("아이디 중복검사를 진행해주세요.");
	            	$('#check_id').css('color', 'green');
	                isIdValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 비밀번호 유효성 검사
	        $("#user_pw").blur(function () {
	        	const userPw = $("#user_pw").val();
	            if (!checkPW.test(userPw)) {
	            	$('#check_pw').text('비밀번호는 영어대소문자 및 숫자와 특수문자를 조합해서 8자리 이상입니다.');
					$('#check_pw').css('color', 'red');
					isPwValid = false;
	                return false;
	            } else {	             
	            	$('#check_pw').text('사용가능한 비밀번호입니다.');
					$('#check_pw').css('color', 'green');
	                isPwValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 비밀번호 확인
	        $("#pw_chk").blur(function () {
	        	const userPw = $("#user_pw").val();
	        	const checkPw = $("#pw_chk").val();
	        	
	            if (userPw !== checkPw) {
	            	$('#check_pwc').text('비밀번호가 서로 다릅니다.');
					$('#check_pwc').css('color', 'red');
	                isPwChkValid = false;
	                return false;
	            } else {
	            	$('#check_pwc').text('비밀번호가 서로 일치합니다.');
					$('#check_pwc').css('color', 'green');
	                isPwChkValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 이름 유효성 검사
	        $("#user_name").blur(function () {
	        	const userName = $("#user_name").val();
	        	
	            if (!checkName.test(userName)) {
	            	$('#check_name').text('옳바르지 않은 이름입니다.');
					$('#check_name').css('color', 'red');
	                isNameValid = false;
	                return false;
	            } else {
	            	$('#check_name').text('이름이 확인되었습니다.');
					$('#check_name').css('color', 'green');
	                isNameValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 이메일 유효성 검사
	        $("#user_email").blur(function () {
	        	const userEmail = $("#user_email").val();
	        	
	            if (!checkEmail.test(userEmail)) {
	            	$('#check_email').text('이메일 형식을 옳바르게 입력해주세요.');
					$('#check_email').css('color', 'red');
	                isEmailValid = false;
	                return false;
	            } else {
	            	$('#check_email').text('이메일인증을 진행해주세요.');
					$('#check_email').css('color', 'green');
	                isEmailValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 닉네임 유효성 검사
	        $("#user_username").blur(function () {
	        	const userNic = $("#user_username").val();
	        	
	            if (!checkUserNmae.test(userNic)) {
	            	$('#check_username').text('사용할수 없는 닉네임입니다.');
					$('#check_username').css('color', 'red');
	                isUsernameValid = false;
	                return false;
	            } else {
	            	$('#check_username').text('닉네임 중복검사를 진행해주세요.');
					$('#check_username').css('color', 'green');
	                isUsernameValid = true;
	                return true;
	            }
	            updateButtonState();
	        });
	    });

	    // 아이디 중복 확인 후 상태 업데이트
	    function checkId() {
	        const userId = $("#user_id").val();
	        if (!checkID.test(userId)) {
            	Swal.fire({
          	      icon: 'warning',
          	      text: '아이디는 영어 대소문자 및 숫자를 조합해서 4자리 이상만 가능합니다.'
          	    });
	            return false;
	        } else{

	        $.ajax({
	            url: "/checkid",
	            type: "post",
	            data: { userId: userId },
	            beforeSend: function (xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function (data) {
	                if (data) {
	                	Swal.fire({
	                	      icon: 'error',
	                	      title: '이미 존재하는 아이디입니다.'
	                	    });
		            	$('#check_id').text("다른 아이디를 입력해 주세요");
		            	$('#check_id').css('color', 'red');
	                    isIdValid = false;
	                    return false;
	                } else {
	                	Swal.fire({
	                	      icon: 'success',
	                	      title: '사용 가능한 아이디입니다.'
	                	    });
		            	$('#check_id').text("사용 가능한 아이디입니다.");
		            	$('#check_id').css('color', 'green');
	                    isIdValid = true;
	                    return true;
	                }
	                updateButtonState();
	            },
	            error: function () {
                	Swal.fire({
              	      icon: 'error',
              	      title: '요청 처리 중 문제가 발생했습니다.'
              	    });
	                isIdValid = false;
	                updateButtonState();
	            }
	        });
	      }
	    }
	 	// 닉네임 중복 확인 후 상태 업데이트
	    function checkUserName() {
	        const userName = $("#user_username").val();
	        if (!checkUserNmae.test(userName)) {
            	Swal.fire({
            	      icon: 'error',
            	      text: '닉네임 형식이 올바르지 않습니다.'
            	    });
	            return false;
	        } else{

	        $.ajax({
	            url: "/checkUserName",
	            type: "post",
	            data: { userName: userName },
	            beforeSend: function (xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function (data) {
	                if (data) {
	                	Swal.fire({
	              	      icon: 'warning',
	              	      title: '이미 존재하는 닉네임입니다.'
	              	    });
	                	$('#check_username').text('다른 닉네임을 입력해주세요.');
						$('#check_username').css('color', 'red');
	                    isUsernameValid = false;
	                } else {
	                	Swal.fire({
	                	      icon: 'success',
	                	      title: '사용 가능한 닉네임입니다.'
	                	    });
	                	$('#check_username').text('사용 가능한 닉네임입니다.');
						$('#check_username').css('color', 'green');
	                    isUsernameValid = true;
	                }
	                updateButtonState();
	            },
	            error: function () {
                	Swal.fire({
                	      icon: 'error',
                	      title: '요청 처리 중 문제가 발생했습니다.'
                	    });
	                isUsernameValid = false;
	                updateButtonState();
	            }
	        });
	      }
	 	}
	 
	 /*
	 	// 이메일 인증번호 전송 함수
	    function sendEmail() {
	        const email = $("#user_email").val();
	        
	        
	        if (!checkEmail.test(email)) {
            	Swal.fire({
          	      icon: 'warning',
          	      title: '유효한 이메일 주소를 입력해주세요.'
          	    });
	            return false;
	        }

	        $.ajax({
	            url: "/send-email",
	            type: "POST",
	            data: { email: email },
	            beforeSend: function (xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function (data) {
                	Swal.fire({
              	      icon: 'success',
              	      title: '인증번호가 전송되었습니다.'
              	    });
	                // 이메일 전송 후 인증번호 입력란 활성화
	                $("#email_auth").prop("disabled", false);
	                $("#verifyEmail").prop("disabled", false);
	            },
	            error: function () {
                	Swal.fire({
                	      icon: 'error',
                	      title: '인증번호 전송에 실패했습니다.'
                	    });
	            }
	        });
	    }

	    // 이메일 인증번호 확인 함수
	    function verifyEmail() {
	        const verificationCode = $("#email_auth").val();

	        $.ajax({
	            url: "/verify-email",
	            type: "POST",
	            data: { verificationCode: verificationCode },
	            beforeSend: function (xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function (data) {
	                alert(data);
	                if (data == true) {
	                	Swal.fire({
	                	      icon: 'success',
	                	      title: '인증이 완료되었습니다.'
	                	    });
	                    // 인증 성공 후 추가 작업 (예: 회원가입 버튼 활성화 등)
	                    isAuthValid = true;
	                    updateButtonState();
	                }else{
	                	Swal.fire({
	                	      icon: 'error',
	                	      title: '인증번호가 틀렸습니다.'
	                	    });
	                	isAuthValid = false;
	                }
	            },
	            error: function () {
                	Swal.fire({
              	      icon: 'error',
              	      title: '인증번호 확인 중 오류가 발생했습니다.'
              	    });
	            }
	        });
	    }
	    */
	 	
	    // 회원가입 실행
	    function submitJoin() {
																				
	        if(isIdValid && isPwValid && isPwChkValid && isNameValid && isEmailValid && isUsernameValid /*&& isAuthValid*/ ) {
            	Swal.fire({
          	      icon: 'success',
          	      title: '회원가입이 완료되었습니다.',
          	      text: '회원 가입을 축하합니다'
          	    });
	            $("#join").submit();
	        }else {
            	Swal.fire({
            	      icon: 'warning',
            	      title: '모든 항목을 올바르게 입력해주세요.'
            	    });
	        }
	    }

	    // 버튼 초기 상태 비활성화
	    $(document).ready(function () {
	        $("#join-btn").prop("disabled", true);
	    });
	    
	</script>
 </html>