<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<meta name="_csrf" th:content="${_csrf.token}">
        <meta name="_csrf_header" th:content="${_csrf.headerName}">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
  		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Member Join</title>
		<!-- Bootstrap CSS -->
  		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
   		 integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		

  <style>
    body {
      min-height: 100vh;
	  background-color: #F4F4F4;
      background: -webkit-gradient(linear, left bottom, right top, from(#92b5db), to(#1d466c));
      background: -webkit-linear-gradient(bottom left, #92b5db 0%, #1d466c 100%);
      background: -moz-linear-gradient(bottom left, #92b5db 0%, #1d466c 100%);
      background: -o-linear-gradient(bottom left, #92b5db 0%, #1d466c 100%);
      background: linear-gradient(to top right, #92b5db 0%, #1d466c 100%);
    }
	.input-form {
      max-width: 680px;

      margin-top: 80px;
      padding: 32px;

      background: #fff;
      -webkit-border-radius: 10px;
      -moz-border-radius: 10px;
      border-radius: 10px;
      -webkit-box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15);
      -moz-box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15);
      box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15)
    }
	
  </style>
		
	</head>
	<body>
		<div class="container">
			<div class="input-form-backgroud row">
				 <div class="input-form col-md-12 mx-auto">
				 	<h4 class="mb-3">회원가입</h4>
					<form action ="/join" id="join" name="join" method="POST" class="validation-form">
						<input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
						<div>
							<div>
								<label for="user_id">아이디</label>
								<input type="text" name="user_id" id="user_id" placeholder="4~12자의 영문 대소문자와 숫자만 가능">
								<button type="button" class="checkId" onclick="checkId()">중복확인</button>
								<br/>
								<div id="id_div"></div>
							</div>
							<div>
								<label for="user_pw">비밀번호</label>
								<input type="password" name="user_pw" id="user_pw" placeholder="8자리 이상의 대소문자와 숫자,특수문자를 포함">
								<br/>
								<div id="pw_div"></div>
							</div>
							<div>
								<label for="pw_chk">비밀번호 확인</label>
								<input type="password" name="pw_chk" id="pw_chk">
								<br/>
								<div id="pwc_div"></div>
							</div>
							<div>
								<label for="user_name">이름</label>
								<input type="text" name="user_name" id="user_name">
								<br/>
								<div id="uname_div"></div>
							</div>
							<div>
								<label for="user_email">이메일</label>
								<input type="email" name="user_email" id="user_email" placeholder="example@example.com">
								<!--  <button type="button" check="chk-num" onclick="sendEmail()">인증번호 전송</button> -->
								<br>
								<div id="email_div"></div>
							</div>
							<!--  
							<div>
								<label for="email_auth">인증번호</label>
								<input type="text" name="email_auth" id="email_auth" placeholder="인증번호 입력">
								<button type="button"  chcek="verifyEmail" onclick="verifyEmail()">인증번호 확인</button>
								<br>
								<div id="auth_div"></div>	
							</div>
							-->
							<div>
								<label for="user_username">닉네임</label>
								<input type="text" name="user_username" id="user_username" placeholder="닉네임을 입력해주세요">
								<button type="button" class="checkUserName" onclick="checkUserName()">중복확인</button>
								<br/>
								<div id="user_div"></div>
							</div>
						</div>
						
							
							<button type="button"  id="join-btn" onclick="submitJoin()">회원가입</button>
					</form>
				</div>
			</div>
		</div>
		
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script type="text/javascript">
	    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

	    // 정규식 정의
	    const checkID = RegExp(/^(?=.*\d)(?=.*[a-zA-Z])[0-9a-zA-Z]{4,}$/);
	    const checkPW = RegExp(/^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[~!@#$%^&*()_+])[A-Za-z\d~!@#$%^&*()_+]{10,}$/);
	    const checkName = RegExp(/^[가-힣]|[A-Z]|[a-z]$/);
	    const checkEmail = RegExp(/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i);
	    const checkUserNmae = RegExp(/^[0-9A-Za-z가-힣ㄱ-ㅎㅏ-ㅣぁ-んァ-ヶ\u4E00-\u9FFF]+$/);

	    // 모든 입력 필드의 유효성 상태를 추적
	    let isIdValid = false;					//아이디 상태
	    let isPwValid = false;					//비밀번호 상태
	    let isPwChkValid = false;				//비밀번호 확인 상태
	    let isNameValid = false;				//이름 상태
	    let isEmailValid = false;				//이메일 상태
	    let isUsernameValid = false;			//닉네임 상태
	    let isAuthValid = false; 				//인증번호 상태 추적

	  //회원가입 페이지 스페이스바 금지 시발
		$(document).keydown(function(event){
			if(event.keyCode === 32){
				event.preventDefault();
			}
		})
	    // 입력 필드 유효성 검사 시 상태 업데이트 및 버튼 활성화
	    function updateButtonState() {
	        if (isIdValid && isPwValid && isPwChkValid && isNameValid && isEmailValid && isUsernameValid) {
	            $("#join-btn").prop("disabled", false);
	        } else {
	            $("#join-btn").prop("disabled", true);
	        }
	    }

	    // 유효성 검사 이벤트 등록
	    $(function () {
	        // 아이디 유효성 검사
	        $("#user_id").blur(function () {
	            const userId = $(this).val();
	            if (!checkID.test(userId)) {
	                $("#id_div").text("아이디는 영어 대소문자 및 숫자를 조합해서 4자리 이상만 가능합니다.");
	                isIdValid = false;
	                return false;
	            } else {
	                $("#id_div").text("");
	                isIdValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 비밀번호 유효성 검사
	        $("#user_pw").blur(function () {
	            if (!checkPW.test($(this).val())) {
	                $("#pw_div").text("영문(대소문자), 숫자, 특수문자를 각 1개 이상 포함한 10자리 이상이어야 합니다.");
	                isPwValid = false;
	                return false;
	            } else {
	                $("#pw_div").text("");
	                isPwValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 비밀번호 확인
	        $("#pw_chk").blur(function () {
	            if ($("#user_pw").val() !== $(this).val()) {
	                $("#pwc_div").text("비밀번호가 다릅니다.");
	                isPwChkValid = false;
	                return false;
	            } else {
	                $("#pwc_div").text("");
	                isPwChkValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 이름 유효성 검사
	        $("#user_name").blur(function () {
	            if (!checkName.test($(this).val())) {
	                $("#uname_div").text("이름을 확인해주세요.");
	                isNameValid = false;
	                return false;
	            } else {
	                $("#uname_div").text("");
	                isNameValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 이메일 유효성 검사
	        $("#user_email").blur(function () {
	            if (!checkEmail.test($(this).val())) {
	                $("#email_div").text("이메일 형식이 잘못되었습니다.");
	                isEmailValid = false;
	                return false;
	            } else {
	                $("#email_div").text("");
	                isEmailValid = true;
	                return true;
	            }
	            updateButtonState();
	        });

	        // 닉네임 유효성 검사
	        $("#user_username").blur(function () {
	            if (!checkUserNmae.test($(this).val())) {
	                $("#user_div").text("닉네임 형식이 올바르지 않습니다.");
	                isUsernameValid = false;
	                return false;
	            } else {
	                $("#user_div").text("");
	                isUsernameValid = true;
	                return true;
	            }
	            updateButtonState();
	        });
	    });

	    // 아이디 중복 확인 후 상태 업데이트
	    function checkId() {
	        const userId = $("#user_id").val();
	        if (!checkID.test(userId)) {
	            alert("아이디는 영어 대소문자 및 숫자를 조합해서 4자리 이상만 가능합니다.");
	            return false;
	        } else{

	        $.ajax({
	            url: "/checkid",
	            type: "post",
	            data: { userId: userId },
	            beforeSend: function (xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function (data) {
	                if (data) {
	                    alert("이미 존재하는 아이디입니다.");
	                    isIdValid = false;
	                    return false;
	                } else {
	                    alert("사용 가능한 아이디입니다.");
	                    isIdValid = true;
	                    return true;
	                }
	                updateButtonState();
	            },
	            error: function () {
	                alert("요청 처리 중 문제가 발생했습니다.");
	                isIdValid = false;
	                updateButtonState();
	            }
	        });
	      }
	    }
	 	// 닉네임 중복 확인 후 상태 업데이트
	    function checkUserName() {
	        const userName = $("#user_username").val();
	        if (!checkUserNmae.test(userName)) {
	            alert("닉네임 형식이 올바르지 않습니다.");
	            return false;
	        } else{

	        $.ajax({
	            url: "/checkUserName",
	            type: "post",
	            data: { userName: userName },
	            beforeSend: function (xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function (data) {
	                if (data) {
	                    alert("이미 존재하는 닉네임입니다.");
	                    isUsernameValid = false;
	                } else {
	                    alert("사용 가능한 닉네임입니다.");
	                    isUsernameValid = true;
	                }
	                updateButtonState();
	            },
	            error: function () {
	                alert("요청 처리 중 문제가 발생했습니다.");
	                isUsernameValid = false;
	                updateButtonState();
	            }
	        });
	      }
	 	}
	 
	 /*
	 	// 이메일 인증번호 전송 함수
	    function sendEmail() {
	        const email = $("#user_email").val();
	        
	        console.log("입력한 이메일 " + email);
	        
	        if (!checkEmail.test(email)) {
	            alert("유효한 이메일 주소를 입력해주세요.");
	            return false;
	        }

	        $.ajax({
	            url: "/send-email",
	            type: "POST",
	            data: { email: email },
	            beforeSend: function (xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function (data) {
	                alert("인증번호가 전송되었습니다.");
	                // 이메일 전송 후 인증번호 입력란 활성화
	                $("#email_auth").prop("disabled", false);
	                $("#verifyEmail").prop("disabled", false);
	            },
	            error: function () {
	                alert("인증번호 전송에 실패했습니다.");
	            }
	        });
	    }

	    // 이메일 인증번호 확인 함수
	    function verifyEmail() {
	        const verificationCode = $("#email_auth").val();

	        $.ajax({
	            url: "/verify-email",
	            type: "POST",
	            data: { verificationCode: verificationCode },
	            beforeSend: function (xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function (data) {
	                alert(data);
	                if (data == true) {
	                    // 인증 성공 후 추가 작업 (예: 회원가입 버튼 활성화 등)
	                    isAuthValid = true;
	                    updateButtonState();
	                }
	            },
	            error: function () {
	                alert("인증번호 확인 중 오류가 발생했습니다.");
	            }
	        });
	    }
*/
	 	
	    // 회원가입 실행
	    function submitJoin() {
																				
	        if(isIdValid && isPwValid && isPwChkValid && isNameValid && isEmailValid && isUsernameValid /*&& isAuthValid*/ ) {
	            alert("회원가입이 완료되었습니다.");
	            $("#join").submit();
	        }else {
	            alert("모든 항목을 올바르게 입력해주세요.");
	        }
	    }

	    // 버튼 초기 상태 비활성화
	    $(document).ready(function () {
	        $("#join-btn").prop("disabled", true);
	    });
	    
		</script>
	</body>

</html>